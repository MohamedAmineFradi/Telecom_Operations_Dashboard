services:
  kafka:
    image: apache/kafka:4.1.1
    hostname: kafka
    container_name: telecom-kafka
    networks:
      - kafka-net
    ports:
      - "9092:9092"   # External clients
      - "7071:7071"   # Prometheus metrics
    environment:
      # KRaft configuration 
      CLUSTER_ID: "4L6g3nShT8qIEaYHq5ZqWA"
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: "broker,controller"
      KAFKA_CONTROLLER_QUORUM_VOTERS: "1@kafka:9093"

      # Listeners
      KAFKA_LISTENERS: "PLAINTEXT://0.0.0.0:9092,CONTROLLER://0.0.0.0:9093,INTERNAL://0.0.0.0:29092"
      KAFKA_ADVERTISED_LISTENERS: "PLAINTEXT://localhost:9092,INTERNAL://kafka:29092"
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: "CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,INTERNAL:PLAINTEXT"
      KAFKA_CONTROLLER_LISTENER_NAMES: "CONTROLLER"
      KAFKA_INTER_BROKER_LISTENER_NAME: "INTERNAL"

      # Performance
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_GROUP_COORDINATOR_REBALANCE_PROTOCOLS: "classic,consumer"

      # JMX Exporter configuration
      KAFKA_OPTS: "-javaagent:/opt/kafka/jmx_exporter.jar=7071:/opt/kafka/kafka-jmx-config.yml -Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.port=9999"
    volumes:
      - ./volumes/kafka-data:/opt/kafka/data
      - ./monitoring/kafka-server.properties:/opt/kafka/config/server.properties
      - ./monitoring/jmx_prometheus_javaagent-1.0.1.jar:/opt/kafka/jmx_exporter.jar
      - ./monitoring/kafka-jmx-config.yml:/opt/kafka/kafka-jmx-config.yml
    command: >
      bash -c "
        if [ ! -f /opt/kafka/data/meta.properties ]; then
          echo \"Formatting Kafka storage with Cluster ID: $${CLUSTER_ID}\"
          /opt/kafka/bin/kafka-storage.sh format -t $${CLUSTER_ID} -c /opt/kafka/config/server.properties
        else
          echo \"Kafka storage already formatted\"
        fi
        exec /opt/kafka/bin/kafka-server-start.sh /opt/kafka/config/server.properties
      "
    healthcheck:
      test: ["CMD-SHELL", "KAFKA_OPTS= /opt/kafka/bin/kafka-broker-api-versions.sh --bootstrap-server=localhost:9092 > /dev/null"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  kafkaui:
    image: provectuslabs/kafka-ui:latest
    container_name: kafkaui
    networks:
      - kafka-net
    ports:
      - "8082:8080"  # UI runs on 8080 internally → mapped to 8082 on host
    environment:
      DYNAMIC_CONFIG_ENABLED: "true"
      KAFKA_CLUSTERS_0_NAME: "QUALIF CLUSTER"
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: "kafka:29092"
    depends_on:
      kafka:
        condition: service_healthy
    restart: unless-stopped

  keycloak:
    image: quay.io/keycloak/keycloak:25.0
    container_name: telecom-keycloak
    networks:
      - kafka-net
    ports:
      - "8081:8080"  # Keycloak runs on 8080 internally → mapped to 8081 on host
    environment:
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://host.docker.internal:5432/keycloak
      KC_DB_USERNAME: postgres
      KC_DB_PASSWORD: postgres
      KC_HOSTNAME_STRICT: "false"
      KC_HTTP_ENABLED: "true"
      KC_METRICS_ENABLED: "true"
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
    command: start-dev
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  prometheus:
    image: prom/prometheus:latest
    container_name: telecom-prometheus
    networks:
      - kafka-net
    ports:
      - "9090:9090"
    volumes:
      - ./volumes/prometheus-data:/prometheus
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.enable-lifecycle'
    depends_on:
      kafka:
        condition: service_healthy
    restart: unless-stopped

  grafana:
    image: grafana/grafana:latest
    container_name: telecom-grafana
    networks:
      - kafka-net
    ports:
      - "3000:3000"
    user: "${UID:-1000}:${GID:-1000}"
    environment:
      GF_SECURITY_ADMIN_PASSWORD: "admin"
    volumes:
      - ./volumes/grafana-data:/var/lib/grafana
    depends_on:
      - prometheus
    restart: unless-stopped

networks:
  kafka-net:
    driver: bridge